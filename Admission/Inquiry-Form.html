<!DOCTYPE html>
<html lang="en" ng-app="admissionApp">

<head>
  <meta charset="UTF-8">
  <title>Admission Inquiry Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(120deg, #e3f2fd, #fce4ec);
      margin: 0;
      padding: 20px;
    }

    .form-container {
      max-width: 950px;
      background: #fff;
      margin: auto;
      border-radius: 14px;
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.18);
      padding: 24px;
    }

    .school-header {
      text-align: center;
      padding-bottom: 16px;
      border-bottom: 2px solid #eee;
      margin-bottom: 20px;
    }

    .school-logo {
      width: 75px;
      height: 75px;
      object-fit: contain;
    }

    .school-name {
      font-size: 22px;
      font-weight: 700;
      color: #1a237e;
    }

    .school-address {
      font-size: 13px;
      color: #555;
      margin-top: 4px;
    }

    h2 {
      text-align: center;
      color: #283593;
      margin-bottom: 20px;
    }

    .section-title {
      font-weight: 700;
      color: #3949ab;
      margin: 24px 0 10px;
      border-bottom: 2px solid #eee;
      padding-bottom: 4px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .form-group {
      flex: 1 1 250px;
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    input,
    select,
    textarea {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    textarea { resize: vertical; }

    input.ng-invalid.ng-touched,
    select.ng-invalid.ng-touched,
    textarea.ng-invalid.ng-touched {
      border-color: #e53935;
    }

    .submit-btn {
      background: #3949ab;
      color: #fff;
      border: none;
      padding: 15px;
      font-size: 16px;
      border-radius: 8px;
      width: 100%;
      cursor: pointer;
      margin-top: 24px;
    }

    .submit-btn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    .success {
      color: green;
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
    }
  </style>
</head>

<body ng-controller="AdmissionCtrl">

<div class="form-container">

  <!-- SCHOOL HEADER -->
  <div class="school-header">
    <img class="school-logo" ng-src="{{orgInfo.Image}}" alt="School Logo">
    <div class="school-name">{{orgInfo.Name}}</div>
    <div class="school-address">{{orgInfo.FullAddress}}</div>
  </div>

  <h2>Admission Inquiry Form</h2>

  <form name="admissionForm" novalidate ng-submit="submit()">

    <!-- STUDENT DETAILS -->
    <div class="section-title">Student Details</div>

    <div class="row">
      <div class="form-group">
        <label>Full Name *</label>
        <input ng-model="model.FullName" required>
      </div>

      <div class="form-group">
        <label>Gender *</label>
        <select ng-model="model.GenderId" required>
          <option value="">Select</option>
          <option value="501">Male</option>
          <option value="502">Female</option>
        </select>
      </div>

      <div class="form-group">
        <label>Date of Birth *</label>
        <input type="date" ng-model="model.DateOfBirth" required>
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label>Mobile *</label>
        <input ng-model="model.Mobile" ng-pattern="/^[0-9]{10}$/" required>
      </div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" ng-model="model.Email">
      </div>

      <div class="form-group">
        <label>Aadhaar</label>
        <input ng-model="model.AadharNumber" ng-pattern="/^[0-9]{12}$/">
      </div>
    </div>

    <!-- CLASS & SECTION -->
    <div class="row">
      <div class="form-group">
        <label>Class *</label>
        <select
          ng-model="model.BatchId"
          ng-options="c.value as c.label for c in classList"
          ng-change="onClassChange()"
          required>
          <option value="">Select Class</option>
        </select>
      </div>

      <div class="form-group" ng-if="sectionList.length">
        <label>Section</label>
        <select
          ng-model="model.SectionId"
          ng-options="s.value as s.label for s in sectionList"
          ng-disabled="!sectionList.length" required>
          <option value="">Select Section</option>
        </select>
      </div>

    <div class="form-group" >
        <label>Academic Year</label>
        <select
          ng-model="model.YearId"
          ng-options="s.value as s.label for s in yearList"
          required>
          <option value="">Select Year</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Address *</label>
      <textarea ng-model="model.Address" required></textarea>
    </div>

    <!-- PARENT DETAILS -->
    <div class="section-title">Parent Details</div>

    <div class="row">
      <div class="form-group">
        <label>Father Name *</label>
        <input ng-model="model.FatherName" required>
      </div>

      <div class="form-group">
        <label>Father Mobile *</label>
        <input ng-model="model.FatherMobile" ng-pattern="/^[0-9]{10}$/" required>
      </div>

      <div class="form-group">
        <label>Father Occupation</label>
        <input ng-model="model.FatherOccupation">
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label>Mother Name</label>
        <input ng-model="model.MotherName">
      </div>

      <div class="form-group">
        <label>Mother Mobile</label>
        <input ng-model="model.MotherMobile" ng-pattern="/^[0-9]{10}$/">
      </div>

      <div class="form-group">
        <label>Mother Occupation</label>
        <input ng-model="model.MotherOccupation">
      </div>
    </div>

    <!-- ADDITIONAL -->
    <div class="section-title">Additional Information</div>

    <div class="row">
      <div class="form-group">
        <label>Previous School</label>
        <input ng-model="model.PrevSchool">
      </div>

      <div class="form-group">
        <label>Mother Tongue</label>
        <input ng-model="model.MotherTougue">
      </div>

      <div class="form-group">
        <label>Religion</label>
        <input ng-model="model.Religion">
      </div>
    </div>

    <button
  class="submit-btn"
  type="submit"
  ng-disabled="admissionForm.$invalid || isSubmitting">

  <span ng-if="!isSubmitting">Submit Admission Inquiry</span>
  <span ng-if="isSubmitting">Processing...</span>

</button>

    <div class="success" ng-if="successMsg">{{successMsg}}</div>

  </form>
</div>

<script>
angular.module('admissionApp', [])
.controller('AdmissionCtrl', function ($scope, $http) {

  function getQueryParams() {
    const p = {};
    location.search.substring(1).split("&").forEach(x => {
      const [k, v] = x.split("=");
      if (k) p[k] = decodeURIComponent(v);
    });
    return p;
  }

  const query = getQueryParams();
  const baseUrl = 'https://api.schoolvertex.com/api';

  $scope.classList = [];
  $scope.sectionList = [];
  $scope.yearList = [
    { value: 8, label: '2025-26'},
{ value: 9, label: '2026-27'},
{ value: 10, label: '2027-28'}];

  if (query.orgid) {
    $http.get(`${baseUrl}/Organisation/GetInfoForCertificate/${query.orgid}`)
      .then(res => {
        $scope.orgInfo = res.data;

        $http.get(`${baseUrl}/Batch/GetActivePrimaryBatchList/${query.orgid}`)
          .then(cls => {
            $scope.classList = cls.data;
          });
      });
  }

  $scope.onClassChange = function () {
    $scope.sectionList = [];
    $scope.model.SectionId = null;

    if (!$scope.model.BatchId) return;

    $http.get(`${baseUrl}/Section/GetNames/${$scope.model.BatchId}`)
      .then(sec => {
        $scope.sectionList = sec.data;
      });
  };

  $scope.model = {
    UserTypeId: 4001,
    OrganisationId: Number(query.orgid),
    StatusId: 2201,
    IsJoiningPending: true,
    CreatedDate: new Date().toISOString()
  };

  $scope.isSubmitting = false;

  $scope.submit = function () {
    if ($scope.admissionForm.$invalid) return;

    $scope.model.DateOfBirth = toDateOnly($scope.model.DateOfBirth);
    $scope.model.CreatedDate = toLocalDateTime($scope.model.CreatedDate || new Date());
    $scope.isSubmitting = true;
    $http.post(
      `${baseUrl}/AdmissionReport/Save`,
      $scope.model
    ).then(() => {
      $scope.successMsg = "Admission inquiry submitted successfully!";
      alert("Admission inquiry submitted successfully!");
      $scope.model = {};
      $scope.admissionForm.$setPristine();
    }, () => {
      alert("Failed to submit admission inquiry");
    }).finally(() => {
    $scope.isSubmitting = false; // âœ… reset button state
  });
  };


  function toLocalDateTime(date) {
  if (!date) return null;

  const d = new Date(date);
  const tzOffsetMs = d.getTimezoneOffset() * 60000;

  return new Date(d.getTime() - tzOffsetMs).toISOString().slice(0, -1);
}

function toDateOnly(date) {
  if (!date) return null;

  const d = new Date(date);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');

  return `${yyyy}-${mm}-${dd}`;
}
});
</script>

</body>
</html>

